name: DÃ©ploiement Trading Lab ðŸš€
run-name: ${{ gitea.actor }} met Ã  jour le bot ðŸ¤–
on:
  push:
    branches:
      - main  # Se dÃ©clenche UNIQUEMENT sur la branche main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¢ DÃ©marrage
        run: echo "DÃ©ploiement initiÃ©..."

      - name: ðŸš€ Connexion SSH et Mise Ã  jour
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            # 1. Aller dans le dossier du code source (sur le Pi)
            cd ~/mon-serveur/trading-lab
            
            # 2. RÃ©cupÃ©rer le dernier code depuis Gitea
            # (Assurez-vous que git est configurÃ© pour pull sans mot de passe, sinon voir note ci-dessous*)
            git pull origin main
            
            # 3. Revenir Ã  la racine pour Docker Compose
            cd ~/mon-serveur
            
            # 4. Reconstruire SEULEMENT le conteneur de trading
            docker compose up -d --build trading-lab-pro
            
            # 5. Nettoyer les vieilles images (pour sauver la carte SD)
            docker image prune -f